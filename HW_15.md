# HOMEWORK #15. Оптимизация производительности. Профилирование. Мониторинг.

### 1. Возьмите сложную выборку из предыдущих ДЗ с несколькими join и подзапросами. Постройте EXPLAIN в 3 формата.

> Обычный план запроса на основе статистики:
![Alt text](image.png)

```sql
/* 
----------------------------------------------
Пример, на основе которого будет выполнено д/з:
----------------------------------------------

--> view v_prodinfo 
*/
create view store.v_prodinfo as 
with cte_list as (
select
p.id,
p.product_name,
p.list_price,
c.category_name,
s.part_quantity,
(select v.vendor_name from store.vendor v
where v.id = s.vendor_id) as vendor_name
from  store.shipment s
join store.product p on s.id = p.part_id
join store.category c on c.id = p.category_id
) 
select
r.vendor_name,
r.category_name,
sum(case when r.product_name <> 'pepperoni' then r.part_quantity else 0 end) v_sum1,
sum(r.part_quantity) v_sum2,
min(r.list_price) v_min,
max(r.list_price) v_max
from cte_list r
group by r.vendor_name, r.category_name;
```
```sql
/* format = tree (без индекса) */
Table scan on v  (cost=2.5..2.5 rows=0) (actual time=0.157..0.157 rows=1 loops=1)
    -> Materialize  (cost=0..0 rows=0) (actual time=0.156..0.156 rows=1 loops=1)
        -> Table scan on <temporary>  (actual time=0.146..0.146 rows=1 loops=1)
            -> Aggregate using temporary table  (actual time=0.145..0.145 rows=1 loops=1)
                -> Table scan on r  (cost=5.41..7.4 rows=4.55) (actual time=0.117..0.119 rows=4 loops=1)
                    -> Materialize CTE cte_list  (cost=4.85..4.85 rows=4.55) (actual time=0.116..0.116 rows=4 loops=1)
                        -> Nested loop inner join  (cost=4.4 rows=4.55) (actual time=0.0646..0.0832 rows=4 loops=1)
                            -> Nested loop inner join  (cost=2.8 rows=4.55) (actual time=0.0567..0.0671 rows=4 loops=1)
                                -> Filter: (store.c.category_name = ''meat'')  (cost=1.65 rows=1.4) (actual time=0.0299..0.0364 rows=1 loops=1)
                                    -> Table scan on c  (cost=1.65 rows=14) (actual time=0.0246..0.0298 rows=14 loops=1)
                                -> Index lookup on p using fk_category (category_id=store.c.id)  (cost=0.732 rows=3.25) (actual time=0.0257..0.029 rows=4 loops=1)
                            -> Single-row index lookup on s using PRIMARY (id=store.p.part_id)  (cost=0.272 rows=1) (actual time=0.00351..0.00355 rows=1 loops=4)
                        -> Select #4 (subquery in projection; dependent)
                            -> Single-row index lookup on v using PRIMARY (id=store.s.vendor_id)  (cost=0.35 rows=1) (actual time=0.00278..0.00284 rows=1 loops=4)
```

```sql
/* format = tree (с индексом) */
-> Table scan on v  (cost=2.5..2.5 rows=0) (actual time=0.137..0.137 rows=1 loops=1)
    -> Materialize  (cost=0..0 rows=0) (actual time=0.136..0.136 rows=1 loops=1)
        -> Table scan on <temporary>  (actual time=0.127..0.127 rows=1 loops=1)
            -> Aggregate using temporary table  (actual time=0.126..0.126 rows=1 loops=1)
                -> Table scan on r  (cost=3.42..5.17 rows=3.25) (actual time=0.0977..0.0993 rows=4 loops=1)
                    -> Materialize CTE cte_list  (cost=2.64..2.64 rows=3.25) (actual time=0.0962..0.0962 rows=4 loops=1)
                        -> Nested loop inner join  (cost=2.31 rows=3.25) (actual time=0.0521..0.0659 rows=4 loops=1)
                            -> Nested loop inner join  (cost=1.18 rows=3.25) (actual time=0.0458..0.051 rows=4 loops=1)
                                -> Index lookup on c using idx_category_catname (upper(category_name)=''meat'')  (cost=0.35 rows=1) (actual time=0.0252..0.0262 rows=1 loops=1)
                                -> Index lookup on p using fk_category (category_id=store.c.id)  (cost=0.825 rows=3.25) (actual time=0.0197..0.0233 rows=4 loops=1)
                            -> Single-row index lookup on s using PRIMARY (id=store.p.part_id)  (cost=0.281 rows=1) (actual time=0.00316..0.00321 rows=1 loops=4)
                        -> Select #4 (subquery in projection; dependent)
                            -> Single-row index lookup on v using PRIMARY (id=store.s.vendor_id)  (cost=0.35 rows=1) (actual time=0.00269..0.00275 rows=1 loops=4)
```

```sql
/* format = json (с индексом)*/
{
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "2.84"
    },
    "table": {
      "table_name": "v",
      "access_type": "ALL",
      "rows_examined_per_scan": 3,
      "rows_produced_per_join": 3,
      "filtered": "100.00",
      "cost_info": {
        "read_cost": "2.54",
        "eval_cost": "0.30",
        "prefix_cost": "2.84",
        "data_read_per_join": "3K"
      },
      "used_columns": [
        "vendor_name",
        "category_name",
        "v_sum1",
        "v_sum2",
        "v_min",
        "v_max"
      ],
      "materialized_from_subquery": {
        "using_temporary_table": true,
        "dependent": false,
        "cacheable": true,
        "query_block": {
          "select_id": 2,
          "cost_info": {
            "query_cost": "2.84"
          },
          "grouping_operation": {
            "using_temporary_table": true,
            "using_filesort": false,
            "table": {
              "table_name": "r",
              "access_type": "ALL",
              "rows_examined_per_scan": 3,
              "rows_produced_per_join": 3,
              "filtered": "100.00",
              "cost_info": {
                "read_cost": "2.54",
                "eval_cost": "0.30",
                "prefix_cost": "2.84",
                "data_read_per_join": "4K"
              },
              "used_columns": [
                "id",
                "product_name",
                "list_price",
                "category_name",
                "part_quantity",
                "vendor_name"
              ],
              "materialized_from_subquery": {
                "using_temporary_table": true,
                "dependent": false,
                "cacheable": true,
                "query_block": {
                  "select_id": 3,
                  "cost_info": {
                    "query_cost": "2.31"
                  },
                  "nested_loop": [
                    {
                      "table": {
                        "table_name": "c",
                        "access_type": "ref",
                        "possible_keys": [
                          "PRIMARY",
                          "idx_category_catname"
                        ],
                        "key": "idx_category_catname",
                        "used_key_parts": [
                          "upper(`category_name`)"
                        ],
                        "key_length": "403",
                        "ref": [
                          "const"
                        ],
                        "rows_examined_per_scan": 1,
                        "rows_produced_per_join": 1,
                        "filtered": "100.00",
                        "cost_info": {
                          "read_cost": "0.25",
                          "eval_cost": "0.10",
                          "prefix_cost": "0.35",
                          "data_read_per_join": "816"
                        },
                        "used_columns": [
                          "id",
                          "category_name",
                          "upper(`category_name`)"
                        ]
                      }
                    },
                    {
                      "table": {
                        "table_name": "p",
                        "access_type": "ref",
                        "possible_keys": [
                          "fk_category",
                          "fk_shipment"
                        ],
                        "key": "fk_category",
                        "used_key_parts": [
                          "category_id"
                        ],
                        "key_length": "4",
                        "ref": [
                          "store.c.id"
                        ],
                        "rows_examined_per_scan": 3,
                        "rows_produced_per_join": 3,
                        "filtered": "100.00",
                        "cost_info": {
                          "read_cost": "0.50",
                          "eval_cost": "0.33",
                          "prefix_cost": "1.18",
                          "data_read_per_join": "3K"
                        },
                        "used_columns": [
                          "id",
                          "product_name",
                          "category_id",
                          "list_price",
                          "part_id"
                        ]
                      }
                    },
                    {
                      "table": {
                        "table_name": "s",
                        "access_type": "eq_ref",
                        "possible_keys": [
                          "PRIMARY"
                        ],
                        "key": "PRIMARY",
                        "used_key_parts": [
                          "id"
                        ],
                        "key_length": "4",
                        "ref": [
                          "store.p.part_id"
                        ],
                        "rows_examined_per_scan": 1,
                        "rows_produced_per_join": 3,
                        "filtered": "100.00",
                        "cost_info": {
                          "read_cost": "0.81",
                          "eval_cost": "0.33",
                          "prefix_cost": "2.31",
                          "data_read_per_join": "156"
                        },
                        "used_columns": [
                          "id",
                          "part_quantity",
                          "vendor_id"
                        ]
                      }
                    }
                  ],
                  "select_list_subqueries": [
                    {
                      "dependent": true,
                      "cacheable": false,
                      "query_block": {
                        "select_id": 4,
                        "cost_info": {
                          "query_cost": "0.35"
                        },
                        "table": {
                          "table_name": "v",
                          "access_type": "eq_ref",
                          "possible_keys": [
                            "PRIMARY"
                          ],
                          "key": "PRIMARY",
                          "used_key_parts": [
                            "id"
                          ],
                          "key_length": "4",
                          "ref": [
                            "store.s.vendor_id"
                          ],
                          "rows_examined_per_scan": 1,
                          "rows_produced_per_join": 1,
                          "filtered": "100.00",
                          "cost_info": {
                            "read_cost": "0.25",
                            "eval_cost": "0.10",
                            "prefix_cost": "0.35",
                            "data_read_per_join": "1K"
                          },
                          "used_columns": [
                            "id",
                            "vendor_name"
                          ]
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    }
  }
```
### 2. Оцените план прохождения запроса, найдите самые тяжелые места.

> Визуальный план запроса:
![Alt text](image-1.png)
``` text
Одна из проблем full table scan на аллиасе (с)
```
``` sql
/* Пример запроса к БД: */

select * from store.v_prodinfo v
where v.category_name = 'meat';
```

### 3(*). Оптимизировать запрос (можно использовать индексы, хинты, сбор статистики, гистограммы). Все действия и результаты опишите в README.md. 

> Добавим функциональный индекс по названию категории, т.к. этот индекс будет надежнее, так как предусматривает варианты, когда пользователь может случайно написать название категории нарушив регистр

![Alt text](image-2.png)

> Визуальный план запроса после добавления индекса:

![Alt text](image-3.png)

``` sql
/* Пример запроса к БД */
select * from store.v_prodinfo v
where upper(v.category_name) = 'meat';
```