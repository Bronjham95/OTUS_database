# HOMEWORK #18. MySQL - InnoDB Cluster.

### Задача: реализовать модель данных БД, определить сущности, построить связи, выполнить декомпозицию и нормализацию

### За основу берем практическую структуру данных с заказчиками интернет магазина (файл some_customers.csv.gz).

### Задание повышенной сложности:
### --> плюс 10 баллов загрузить данные из CSV в вашу модель [✓]
### --> плюс 3 балла за развернутый кластер innodb с роутером и проверкой работоспособности. [✖]

#### 1. Скачан архив и разархивирован [✓].

#### 2. Данные из .csv были загружены в БД [✓].

``` text
Воспользовался утилитой mysqlimport: положил .csv в дирректорию mysql-files, накатил данные в БД уже в заранее созданную табличку.
```

``` bash
sudo mysqlimport --fields-optionally-enclosed-by='"' --fields-terminated-by=',' --ignore-lines=1 --lines-terminated-by='\n' --user=root -p hw_test /var/lib/mysql-files/test_data.csv
```

#### Табличка:
![Alt text](image.png)

#### Данные: 
![Alt text](image-1.png)


``` text
В процессе анализа было выделено 10 сущностей, а т.ж. приведена нормализация.
```

#### Итоговая БД:

![Alt text](image-2.png)


#### 3. Основное и дополнительное задание.
``` text
Ниже будут привдены скрипты создания таблиц: pk, fk и скриптов для наполнения таблиц, а т.ж. проверочные скрипты.
```

``` sql
create database hw_test;

use hw_test;

create table hw_test.test_data(
title 					varchar(100),
first_name 				varchar(100),
last_name  			    varchar(100),
correspondence_language varchar(100),
birth_date				varchar(100),
gender					varchar(100),
marital_status			varchar(100),
country					varchar(100),
postal_code				varchar(100),
region					varchar(100),
city					varchar(100),
street					varchar(100),
building_number			varchar(100)
);


-- PERSON
create table hw_test.person(
id integer not null AUTO_INCREMENT primary key,
first_name    varchar(60),
last_name     varchar(60),
birth_date    varchar(15) default null,
country_id    integer,
marial_status varchar(15) default null,
language_id	  integer,
title_id	  integer,
gender_id	  integer
);

-- COUNTRY 
create table hw_test.country(
id 		     integer not null AUTO_INCREMENT primary key,
region_id    integer,
city_id		 integer,
street_id	 integer,
country_code varchar(20) not null
);

-- COUNTRY_CODE
create table hw_test.country_code(
id integer not null auto_increment primary key,
country_name varchar(10)
);

-- REGION
create table hw_test.region(
id 			integer not null AUTO_INCREMENT primary key,
region_name varchar(35)
);

-- CITY
create table hw_test.city(
id 		  integer not null AUTO_INCREMENT primary key,
city_name varchar(100),
postal_code varchar(15)
);

-- STREET
create table hw_test.street(
id 			    integer not null AUTO_INCREMENT primary key,
street_name     varchar(100),
building_id integer
);

-- BUILDING
create table hw_test.building(
id integer not null AUTO_INCREMENT primary key,
building_number varchar(15)
);

-- TITLE
create table hw_test.title(
id integer not null AUTO_INCREMENT primary key,
title_name varchar(20)
);

-- LANGUAGE
create table hw_test.lang(
id integer not null AUTO_INCREMENT primary key,
language_name varchar(3)
);

-- GENDER
create table hw_test.gender(
id integer not null AUTO_INCREMENT primary key,
gender_name VARCHAR(10)
);

-- ================
-- ПРОВЕРКА ДАННЫХ:
-- ================
select count(*) as cnt, count(distinct city) as cnt from hw_test.test_data -- 1084/ 854
where city not in ('');

select count(*) as cnt, count(distinct street) as dis_cnt from hw_test.test_data -- 1120/1113
where street not in ('');

select count(*) as cnt, count(distinct region) as dis_cnt from hw_test.test_data -- 203/112
where region not in ('');

select count(*) as cnt, count(distinct gender) as dis_cnt from hw_test.test_data -- 1142/3
where gender not in ('');

select count(*) as cnt, count(distinct correspondence_language) as dis_cnt from hw_test.test_data -- 1133/17
where correspondence_language not in ('');

select count(*) as cnt, count(distinct title) as dis_cnt from hw_test.test_data -- 1023/31
where title not in ('');

select count(*) as cnt, count(distinct postal_code) as dis_cnt from hw_test.test_data -- 1111/1078
where postal_code not in ('');

select count(*) as cnt, count(distinct country) as dis_cnt from hw_test.test_data -- 1154/21
where country not in ('');

-- =======
-- INSERT:
-- =======
insert into hw_test.city
(city_name, postal_code)
select city, postal_code from hw_test.test_data
where (city != '' or postal_code != '');

insert into hw_test.street
(street_name, building_id)
select t33.street_name, t22.id from hw_test.test_data t11 
join hw_test.street t33 on t11.street = t33.street_name
left join hw_test.building t22 on (t11.building_number = t22.building_number and t11.street = t33.street_name)
where (t11.street != '' or t11.building_number != '');

drop table hw_test.street;
select * from hw_test.street;

insert into hw_test.street
(street_name, building_id)
select t11.street, t22.id from hw_test.test_data t11
left join hw_test.building t22 on t11.building_number = t22.building_number
where (t11.street != '' or t22.building_number != '');

insert into hw_test.region
(region_name)
select region from hw_test.test_data
where region != '';

insert into hw_test.country_code
(country_name)
select distinct country from hw_test.test_data;

insert into hw_test.building
(building_number)
select distinct building_number from hw_test.test_data
where building_number != '';

insert into hw_test.country
(region_id, city_id, street_id, country_code)
select t3.id, t4.id, t5.id, t6.id from hw_test.test_data t1
left join hw_test.region t3 on t1.region = t3.region_name
left join hw_test.city t4  on (t1.city = t4.city_name and t1.postal_code = t4.postal_code)
left join hw_test.street t5 on (t1.street = t5.street_name)
left join hw_test.country_code t6 on t1.country = t6.country_name;

insert into hw_test.building
(building_number)
select distinct building_number from hw_test.test_data
where building_number != '';

insert into hw_test.gender
(gender_name)
select distinct gender from hw_test.test_data
where building_number != '';

insert into hw_test.title
(title_name)
select distinct title from hw_test.test_data
where title != '';

insert into hw_test.lang
(language_name)
select distinct correspondence_language from hw_test.test_data
where correspondence_language != '';

insert into hw_test.person
(first_name, last_name, birth_date, country_id, marial_status, language_id, title_id, gender_id)
select u1.first_name, u1.last_name, u1.birth_date, u6.id, u1.marital_status, u2.id, u4.id, u3.id from hw_test.test_data u1
left join hw_test.lang u2 on u1.correspondence_language = u2.language_name
left join hw_test.gender u3 on u1.gender = u3.gender_name
left join hw_test.title u4 on u1.title = u4.title_name
left join hw_test.country_code u6 on u6.country_name = u1.country;

-- ===================================================
-- Проверка того, что все таблицы заполнились данными:
-- ===================================================
select * from hw_test.building;
select * from hw_test.street;
select * from hw_test.city;
select * from hw_test.region;
select * from hw_test.country;
select * from hw_test.gender;
select * from hw_test.title;
select * from hw_test.lang;
select * from hw_test.person;
select * from hw_test.test_data;

-- FOREIGN KEY
ALTER TABLE person ADD FOREIGN KEY (title_id) REFERENCES title(id);

ALTER TABLE person ADD FOREIGN KEY (language_id) REFERENCES lang(id);

ALTER TABLE person ADD FOREIGN KEY (gender_id) REFERENCES gender(id);

ALTER TABLE person ADD FOREIGN KEY (country_id) REFERENCES country(id);

ALTER TABLE country ADD FOREIGN KEY (region_id) REFERENCES region(id);

ALTER TABLE country ADD FOREIGN KEY (city_id) REFERENCES city(id);

ALTER TABLE country ADD FOREIGN KEY (region_id) REFERENCES region(id);

ALTER TABLE country ADD FOREIGN KEY (street_id) REFERENCES street(id);

ALTER TABLE country ADD FOREIGN KEY (country_code) REFERENCES country_code(id);

ALTER TABLE street ADD FOREIGN KEY (building_id) REFERENCES building(id);

```